<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Construction Planner</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/controls/OrbitControls.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #e9ecef;
      overflow: hidden;
    }
    .planner-container {
      display: flex;
      flex-direction: column;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      max-width: 350px;
      margin-right: 20px;
    }
    h2 {
      margin: 0 0 20px 0;
      font-size: 24px;
      color: #333;
    }
    h3 {
      margin: 20px 0 10px;
      font-size: 18px;
      color: #555;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    .step {
      margin-bottom: 20px;
    }
    label {
      display: block;
      font-size: 14px;
      color: #444;
      margin-bottom: 8px;
    }
    select, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
      padding: 12px;
    }
    button:hover {
      background-color: #0056b3;
    }
    canvas {
      display: block;
    }
    #canvas-container {
      flex-grow: 1;
      margin-left: 370px;
      height: 100%;
      position: relative;
    }
    #info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      color: white;
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 3px;
      font-size: 12px;
    }
    .step-guide {
      font-size: 11px;
      color: #777;
      display: block;
      margin-top: -5px;
    }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="planner-container">
    <h2>Build Your Plan</h2>
    <div class="step" id="step1">
      <h3>Step 1: General</h3>
      <label for="floor-plan" class="tooltip">Floor Plan: <span class="step-guide">(Choose building height)</span>
        <span class="tooltiptext">Select number of floors</span>
      </label>
      <select id="floor-plan" onchange="updateModel()">
        <option value="single">Single Floor</option>
        <option value="double">Double Floor</option>
        <option value="multi">Multi Floor (3)</option>
      </select>
      <label for="site-size" class="tooltip">Site Size: <span class="step-guide">(Select plot size)</span>
        <span class="tooltiptext">Choose plot area</span>
      </label>
      <select id="site-size" onchange="updateModel()">
        <option value="small">Small (1000 sqft)</option>
        <option value="medium">Medium (2000 sqft)</option>
        <option value="large">Large (3000 sqft)</option>
      </select>
    </div>
    <div class="step" id="step2" style="display: none;">
      <h3>Step 2: Exterior</h3>
      <label for="roofing" class="tooltip">Roofing Style: <span class="step-guide">(Pick roof design)</span>
        <span class="tooltiptext">Choose roof type</span>
      </label>
      <select id="roofing" onchange="updateModel()">
        <option value="flat">Flat Roof</option>
        <option value="pitched">Pitched Roof</option>
        <option value="mansard">Mansard Roof</option>
      </select>
      <label for="exterior-finish" class="tooltip">Exterior Finish: <span class="step-guide">(Select wall material)</span>
        <span class="tooltiptext">Pick wall finish</span>
      </label>
      <select id="exterior-finish" onchange="updateModel()">
        <option value="brick">Brick</option>
        <option value="stucco">Stucco</option>
        <option value="siding">Vinyl Siding</option>
      </select>
      <label for="windows" class="tooltip">Windows: <span class="step-guide">(Choose window style)</span>
        <span class="tooltiptext">Select window size</span>
      </label>
      <select id="windows" onchange="updateModel()">
        <option value="standard">Standard</option>
        <option value="large">Large</option>
        <option value="bay">Bay Windows</option>
      </select>
    </div>
    <div class="step" id="step3" style="display: none;">
      <h3>Step 3: Interior</h3>
      <label for="flooring" class="tooltip">Flooring Material: <span class="step-guide">(Choose floor type)</span>
        <span class="tooltiptext">Pick floor material</span>
      </label>
      <select id="flooring" onchange="updateModel()">
        <option value="hardwood">Hardwood</option>
        <option value="tile">Tile</option>
        <option value="carpet">Carpet</option>
      </select>
      <label for="wall-color" class="tooltip">Wall Color: <span class="step-guide">(Select wall color)</span>
        <span class="tooltiptext">Choose interior color</span>
      </label>
      <select id="wall-color" onchange="updateModel()">
        <option value="white">White</option>
        <option value="beige">Beige</option>
        <option value="light-blue">Light Blue</option>
      </select>
      <label for="ceiling" class="tooltip">Ceiling Type: <span class="step-guide">(Pick ceiling design)</span>
        <span class="tooltiptext">Select ceiling style</span>
      </label>
      <select id="ceiling" onchange="updateModel()">
        <option value="flat">Flat</option>
        <option value="vaulted">Vaulted</option>
        <option value="tray">Tray</option>
      </select>
    </div>
    <button onclick="savePlan()">Save Plan</button>
  </div>
  <div id="canvas-container"></div>
  <div id="info">Use mouse to rotate, zoom, and pan</div>

  <script>
    let scene, camera, renderer, controls, buildingGroup, textureLoader;
    let selections = {
      floorPlan: null,
      siteSize: null,
      roofing: null,
      exteriorFinish: null,
      windows: null,
      flooring: null,
      wallColor: null,
      ceiling: null
    };
    let initialized = false;

    function init() {
      if (scene) return;
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x87ceeb);

      camera = new THREE.PerspectiveCamera(75, (window.innerWidth - 370) / window.innerHeight, 0.1, 1000);
      camera.position.set(5, 5, 10);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth - 370, window.innerHeight);
      renderer.shadowMap.enabled = true;
      document.getElementById('canvas-container').appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.minDistance = 5;
      controls.maxDistance = 20;

      const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
      scene.add(ambientLight);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
      directionalLight.position.set(10, 15, 10).normalize();
      directionalLight.castShadow = true;
      scene.add(directionalLight);

      const groundGeometry = new THREE.PlaneGeometry(20, 20);
      const groundMaterial = new THREE.ShadowMaterial();
      groundMaterial.opacity = 0.3;
      const ground = new THREE.Mesh(groundGeometry, groundMaterial);
      ground.rotation.x = -Math.PI / 2;
      ground.position.y = -0.1;
      ground.receiveShadow = true;
      scene.add(ground);

      buildingGroup = new THREE.Group();
      buildingGroup.visible = false; // Hide until first step
      scene.add(buildingGroup);
      textureLoader = new THREE.TextureLoader();

      initialized = true;
      animate();
      window.addEventListener('resize', () => {
        camera.aspect = (window.innerWidth - 370) / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth - 370, window.innerHeight);
      });
    }

    function updateModel() {
      if (!initialized) {
        init();
      }

      const selects = document.querySelectorAll('select');
      selections.floorPlan = document.getElementById('floor-plan').value;
      selections.siteSize = document.getElementById('site-size').value;
      selections.roofing = document.getElementById('roofing').value;
      selections.exteriorFinish = document.getElementById('exterior-finish').value;
      selections.windows = document.getElementById('windows').value;
      selections.flooring = document.getElementById('flooring').value;
      selections.wallColor = document.getElementById('wall-color').value;
      selections.ceiling = document.getElementById('ceiling').value;

      const width = selections.siteSize === 'small' ? 2 : selections.siteSize === 'medium' ? 3 : 4;
      const depth = width;
      const height = selections.floorPlan === 'single' ? 1 : selections.floorPlan === 'double' ? 2 : 3;

      // Incremental building
      if (!buildingGroup.children.length && selections.floorPlan && selections.siteSize) {
        const wallGeometry = new THREE.BoxGeometry(width, height, depth);
        const walls = new THREE.Mesh(wallGeometry, new THREE.MeshStandardMaterial({ color: 0x888888, transparent: true, opacity: 0.5 }));
        walls.castShadow = true;
        walls.receiveShadow = true;
        walls.position.y = height / 2;
        buildingGroup.add(walls);
        buildingGroup.visible = true; // Show group after base
      }

      if (selections.roofing && buildingGroup.children.length === 1) {
        const roofGeometry = selections.roofing === 'pitched' ?
          new THREE.ConeGeometry(width * 0.7, 0.5, 4) : selections.roofing === 'mansard' ?
          new THREE.CylinderGeometry(width * 0.5, width * 0.7, 0.7, 4) : new THREE.BoxGeometry(width, 0.2, depth);
        const roof = new THREE.Mesh(roofGeometry, new THREE.MeshStandardMaterial({ color: 0x444444 }));
        roof.castShadow = true;
        roof.receiveShadow = true;
        roof.position.y = height + (selections.roofing === 'flat' ? 0.1 : 0.35);
        buildingGroup.add(roof);
      }

      if (selections.exteriorFinish && buildingGroup.children.length === 2) {
        textureLoader.load(
          selections.exteriorFinish === 'brick' ? 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80' :
          selections.exteriorFinish === 'stucco' ? 'https://images.unsplash.com/photo-1600585154526-990d71e1745a?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80' :
          'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80',
          (texture) => {
            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(1, height);
            buildingGroup.children[0].material = new THREE.MeshStandardMaterial({
              map: texture, transparent: true, opacity: 0.7, roughness: 0.5, metalness: 0.1
            });
          },
          undefined,
          (error) => console.error('Texture load error:', error)
        );
      }

      if (selections.windows && buildingGroup.children.length === 2) {
        const windowCount = selections.windows === 'standard' ? 2 : selections.windows === 'large' ? 4 : 6;
        const windowMaterial = new THREE.MeshStandardMaterial({ color: 0xadd8e6, transparent: true, opacity: 0.8 });
        for (let i = 0; i < windowCount; i++) {
          const windowGeometry = new THREE.PlaneGeometry(width * 0.2, height * 0.3);
          const windowMesh = new THREE.Mesh(windowGeometry, windowMaterial);
          windowMesh.position.set(
            (i % 2 === 0 ? -1 : 1) * width / 2.1,
            height * (0.5 + (i % 2) * 0.2),
            depth / 2 + 0.01
          );
          windowMesh.castShadow = true;
          buildingGroup.add(windowMesh);
        }
      }

      if (selections.flooring && buildingGroup.children.length <= 3) {
        const floorGeometry = new THREE.PlaneGeometry(width * 0.9, depth * 0.9);
        const floor = new THREE.Mesh(floorGeometry, new THREE.MeshStandardMaterial({ color: 0x888888 }));
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = 0.01;
        floor.receiveShadow = true;
        buildingGroup.add(floor);
        textureLoader.load(
          selections.flooring === 'hardwood' ? 'https://images.unsplash.com/photo-1600585154526-990d71e1745a?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80' :
          selections.flooring === 'tile' ? 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80' :
          'https://images.unsplash.com/photo-1600585154526-990d71e1745a?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80',
          (texture) => {
            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(1, 1);
            buildingGroup.children[buildingGroup.children.length - 1].material = new THREE.MeshStandardMaterial({ map: texture, roughness: 0.4 });
          },
          undefined,
          (error) => console.error('Texture load error:', error)
        );
      }

      if (selections.wallColor && buildingGroup.children.length <= 4) {
        const innerWallGeometry = new THREE.BoxGeometry(width * 0.8, height * 0.9, depth * 0.8);
        const innerWalls = new THREE.Mesh(innerWallGeometry, new THREE.MeshStandardMaterial({
          color: selections.wallColor === 'white' ? 0xffffff : selections.wallColor === 'beige' ? 0xf5f5dc : 0xb0e0e6
        }));
        innerWalls.position.y = height / 2;
        buildingGroup.add(innerWalls);
      }

      if (selections.ceiling && buildingGroup.children.length <= 5) {
        const ceilingGeometry = selections.ceiling === 'vaulted' ?
          new THREE.ConeGeometry(width * 0.8, 0.4, 4) : selections.ceiling === 'tray' ?
          new THREE.BoxGeometry(width * 0.9, 0.2, depth * 0.9) : new THREE.PlaneGeometry(width * 0.9, depth * 0.9);
        const ceiling = new THREE.Mesh(ceilingGeometry, new THREE.MeshStandardMaterial({ color: 0xffffff }));
        ceiling.position.y = height - (selections.ceiling === 'vaulted' ? 0.2 : 0.01);
        if (selections.ceiling !== 'vaulted') ceiling.rotation.x = Math.PI;
        buildingGroup.add(ceiling);
      }

      buildingGroup.scale.set(width / 2, 1, depth / 2);
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    function savePlan() {
      alert(`Plan Saved!\n${Object.entries(selections).map(([k, v]) => `${k.replace(/([A-Z])/g, ' $1').trim()}: ${v || 'Not selected'}`).join('\n')}`);
    }

    function initPlanner() {
      if (!scene) init();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const steps = ['step1', 'step2', 'step3'];
      const selects = document.querySelectorAll('select');
      selects.forEach((select, index) => {
        select.addEventListener('change', () => {
          const currentStep = steps[Math.floor(index / 2)];
          const nextStep = steps[Math.floor(index / 2) + 1];
          if (nextStep && document.getElementById(currentStep).querySelectorAll('select')[1].value) {
            document.getElementById(nextStep).style.display = 'block';
          }
          if (!select.value) {
            select.nextElementSibling.style.color = '#ff0000';
          } else {
            select.nextElementSibling.style.color = '#777';
          }
          updateModel(); // Trigger model update on each change
        });
        if (index > 1) {
          const stepIndex = Math.floor((index - 1) / 2);
          if (stepIndex > 0 && !document.getElementById(steps[stepIndex - 1]).querySelectorAll('select')[1].value) {
            select.parentElement.parentElement.style.display = 'none';
          }
        }
      });
    });
  </script>
</body>
</html>